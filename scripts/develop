#!/usr/bin/env bash

set -e

cd "$(dirname "$0")/.."

HASS_BIN="${PWD}/.venv/bin/hass"
if [[ ! -x "$HASS_BIN" ]]; then
    echo "ERROR: $HASS_BIN not found. Run ./scripts/setup first." >&2
    exit 1
fi

CONFIG_DIR="${PWD}/config/dev"

mkdir -p "$CONFIG_DIR"

# Create a minimal dev configuration (avoids `default_config`, which currently depends
# on `go2rtc` and requires a docker binary/socket in many dev-container setups).
if [[ ! -f "${CONFIG_DIR}/configuration.yaml" ]]; then
        cat >"${CONFIG_DIR}/configuration.yaml" <<'EOF'
homeassistant:
    debug: true

# Minimal set for UI + API in dev
api:
frontend:
http:

# Avoid frontend websocket errors for common panels
sensor:
recorder:
history:
logbook:

automation:
script:
scene:

logger:
    default: info
    logs:
        custom_components.eniris_hacs: debug
EOF
fi

# Set the path to custom_components
## This let's us have the structure we want <root>/custom_components/integration_blueprint
## while at the same time have Home Assistant configuration inside <root>/config
## without resulting to symlinks.
export PYTHONPATH="${PYTHONPATH}:${PWD}/custom_components"

# Start Home Assistant
"$HASS_BIN" --config "$CONFIG_DIR" --debug
